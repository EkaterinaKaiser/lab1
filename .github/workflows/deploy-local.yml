name: Deploy to Local Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check local environment
      run: |
        echo "=== Local Environment Check ==="
        echo "Date: $(date)"
        echo "Uptime: $(uptime)"
        echo "Docker version: $(docker --version)"
        echo "Docker Compose version: $(docker compose version)"
        echo "Available disk space:"
        df -h
        echo "Memory usage:"
        free -h
        echo "Running containers:"
        docker ps -a
        echo "=== Local Environment Check Completed ==="
        
    - name: Clean up old containers and images
      run: |
        echo "=== Cleaning up old containers and images ==="
        
        # Остановка и удаление старых контейнеров приложения
        echo "Stopping and removing old application containers..."
        docker stop university-app || true
        docker rm university-app || true
        
        # Остановка и удаление старых контейнеров баз данных
        echo "Stopping and removing old database containers..."
        docker stop university-postgres || true
        docker rm university-postgres || true
        docker stop university-mongodb || true
        docker rm university-mongodb || true
        
        # Удаление старых образов приложения
        echo "Removing old application images..."
        docker rmi university-app:latest || true
        
        # Удаление старых томов с данными БД
        echo "Removing old database volumes..."
        docker volume rm university_postgres_data || true
        docker volume rm university_mongodb_data || true
        
        # Очистка неиспользуемых образов и контейнеров
        echo "Cleaning up unused Docker resources..."
        docker system prune -f
        
        # Показать освобожденное место
        echo "Docker system usage after cleanup:"
        docker system df
        
        echo "=== Cleanup completed ==="
        
    - name: Setup database locally
      run: |
        echo "=== Setting up database locally ==="
        
        # Запуск PostgreSQL
        echo "Starting PostgreSQL container..."
        docker run -d --name university-postgres \
          -e POSTGRES_DB=university \
          -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=postgres \
          -p 5432:5432 \
          -v university_postgres_data:/var/lib/postgresql/data \
          postgres:15
        
        # Ожидание готовности БД
        echo "Ожидание готовности базы данных..."
        sleep 30
        
        # Проверка готовности БД
        until docker exec university-postgres pg_isready -U postgres; do
          echo "Ожидание готовности PostgreSQL..."
          sleep 2
        done
        
        echo "База данных PostgreSQL запущена и готова к работе"
        
    - name: Setup MongoDB locally
      run: |
        echo "=== Setting up MongoDB locally ==="
        
        # Запуск MongoDB
        echo "Starting MongoDB container..."
        docker run -d --name university-mongodb \
          -e MONGO_INITDB_ROOT_USERNAME=admin \
          -e MONGO_INITDB_ROOT_PASSWORD=admin123 \
          -e MONGO_INITDB_DATABASE=shop \
          -p 27017:27017 \
          -v university_mongodb_data:/data/db \
          -v $(pwd)/mongodb/init:/docker-entrypoint-initdb.d \
          mongo:7
        
        # Ожидание готовности MongoDB
        echo "Ожидание готовности MongoDB..."
        sleep 30
        
        # Диагностика MongoDB
        echo "=== MongoDB Диагностика ==="
        echo "Статус контейнера:"
        docker ps | grep university-mongodb || echo "Контейнер не найден"
        echo "Логи MongoDB:"
        docker logs university-mongodb --tail 10
        echo "=== Конец диагностики ==="
        
        # Проверка готовности MongoDB
        echo "Проверка готовности MongoDB..."
        for i in {1..30}; do
          if docker exec university-mongodb mongosh --eval "print('MongoDB is ready')" > /dev/null 2>&1; then
            echo "MongoDB готов к работе!"
            break
          fi
          echo "Ожидание готовности MongoDB... ($i/30)"
          sleep 2
        done
        
        echo "MongoDB запущен и готов к работе"
        
    - name: Build and deploy application locally
      run: |
        echo "=== Building and deploying application ==="
        
        # Сборка образа
        echo "Building application image..."
        docker build -t university-app:latest .
        
        # Запуск приложения
        echo "Starting application container..."
        docker run -d --name university-app -p 8080:8080 \
          -e DB_HOST=university-postgres \
          -e DB_PORT=5432 \
          -e DB_NAME=university \
          -e DB_USER=postgres \
          -e DB_PASSWORD=postgres \
          -e MONGO_HOST=university-mongodb \
          -e MONGO_PORT=27017 \
          -e MONGO_DB=shop \
          -e MONGO_USER=admin \
          -e MONGO_PASSWORD=admin123 \
          --link university-postgres:postgres \
          --link university-mongodb:mongodb \
          university-app:latest
        
        echo "Приложение успешно развернуто!"
        
    - name: Initialize database with data
      run: |
        echo "=== Initializing database with data ==="
        
        # Выполнение создания таблиц из готового файла
        echo "Создание таблиц..."
        docker exec -i university-postgres psql -U postgres -d university < init/01_create_tables.sql
        
        # Заполнение базы данных тестовыми данными
        echo "Заполнение PostgreSQL тестовыми данными..."
        docker exec -i university-postgres psql -U postgres -d university < init/02_insert_test_data.sql
        echo "PostgreSQL тестовые данные успешно добавлены!"
        
        # Инициализация MongoDB
        echo "Инициализация MongoDB..."
        # MongoDB автоматически выполнит скрипты из /docker-entrypoint-initdb.d при первом запуске
        echo "MongoDB инициализирован автоматически при запуске контейнера"
        
        echo "Инициализация всех баз данных завершена!"
        
    - name: Verify deployment
      run: |
        echo "=== Verifying deployment ==="
        echo "Checking if containers are running..."
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        
        echo "Testing application endpoint..."
        sleep 10
        curl -f http://localhost:8080/ || echo "Application not responding yet"
        
        echo "=== Deployment verification completed ==="
