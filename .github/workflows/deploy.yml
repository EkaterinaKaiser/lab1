name: Deploy Lab Infrastructure (Suricata on Host)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Cleanup previous deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            echo "=== –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è ==="

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Suricata –Ω–∞ —Ö–æ—Å—Ç–µ
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ Suricata..."
            sudo pkill -f "suricata.*-c /etc/suricata/suricata.yaml" 2>/dev/null || true
            sleep 3
            sudo rm -f /var/run/suricata.pid 2>/dev/null || true

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            cd ~ || mkdir -p ~/lab-infrastructure && cd ~/lab-infrastructure
            if [ -f docker-compose.yml ]; then
              docker compose down -v 2>/dev/null || true
            fi

            # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ –∏–º–µ–Ω–∏ (–Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è compose)
            docker rm -f attacker victim 2>/dev/null || true

            # –£–¥–∞–ª—è–µ–º —Å–µ—Ç—å (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
            docker network rm labnet 2>/dev/null || true

            # –û—á–∏—â–∞–µ–º –ø–∞–ø–∫—É
            rm -rf ~/lab-infrastructure
            mkdir -p ~/lab-infrastructure/{rules,logs}

            echo "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          EOF

      - name: Full Suricata & iptables Cleanup
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "=== –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Suricata –∏ iptables ==="

          # 1. –£–±–∏–≤–∞–µ–º –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã Suricata (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É!)
          echo "‚Üí –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö Suricata..."
          sudo pkill -9 -f suricata 2>/dev/null || true
          sleep 2

          # 2. –£–¥–∞–ª—è–µ–º PID –∏ –ª–æ–≥–∏
          echo "‚Üí –£–¥–∞–ª–µ–Ω–∏–µ PID –∏ –ª–æ–≥–æ–≤..."
          sudo rm -f /var/run/suricata.pid
          sudo rm -rf /var/log/suricata/*
          sudo mkdir -p /var/log/suricata

          # 3. –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞
          echo "‚Üí –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤..."
          sudo rm -f /etc/suricata/suricata.yaml
          sudo rm -rf /etc/suricata/rules/*
          sudo mkdir -p /etc/suricata/rules

          # 4. –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ iptables (—É–¥–∞–ª—è–µ–º –í–°–Å, —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å Suricata)
          echo "‚Üí –û—á–∏—Å—Ç–∫–∞ iptables..."
          # –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏
          while sudo iptables -C DOCKER-USER -j PRE-SURICATA 2>/dev/null; do
            sudo iptables -D DOCKER-USER -j PRE-SURICATA
          done
          # –û—á–∏—â–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ü–µ–ø–æ—á–∫—É
          sudo iptables -F PRE-SURICATA 2>/dev/null || true
          sudo iptables -X PRE-SURICATA 2>/dev/null || true
          # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DOCKER-USER –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
          sudo iptables -F DOCKER-USER 2>/dev/null || true
          sudo iptables -X DOCKER-USER 2>/dev/null || true
          sudo iptables -N DOCKER-USER 2>/dev/null || true

          # 5. –°–±—Ä–∞—Å—ã–≤–∞–µ–º nfqueue (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —è–¥—Ä–æ)
          echo "‚Üí –°–±—Ä–æ—Å nfqueue..."
          echo 0 | sudo tee /proc/sys/net/netfilter/nf_queue_maxlen 2>/dev/null || true
          # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
          sudo rmmod nfnetlink_queue 2>/dev/null || true
          sudo modprobe nfnetlink_queue 2>/dev/null || true

          echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          exit 0
          EOF

      - name: Copy files to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" "mkdir -p ~/lab-infrastructure/rules"

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            suricata.yaml \
            ${SSH_USER}@${SSH_HOST}:~/lab-infrastructure/

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -r rules/ \
            ${SSH_USER}@${SSH_HOST}:~/lab-infrastructure/

      - name: Install and configure Suricata on host
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Suricata –Ω–∞ —Ö–æ—Å—Ç ==="

            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–∫–µ—Ç—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Suricata
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository -y ppa:oisf/suricata-stable
            sudo apt-get update
            sudo apt-get install -y suricata

            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥–∏
            sudo mkdir -p /etc/suricata/rules
            sudo cp ~/lab-infrastructure/suricata.yaml /etc/suricata/suricata.yaml
            sudo cp ~/lab-infrastructure/rules/* /etc/suricata/rules/ 2>/dev/null || true

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º suricata.yaml..."
            sudo suricata -T -c /etc/suricata/suricata.yaml || { echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!"; exit 1; }

            echo "Suricata —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
          EOF

      - name: Start Suricata in IPS mode (nfq)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "=== –ó–∞–ø—É—Å–∫ Suricata –≤ IPS-—Ä–µ–∂–∏–º–µ ==="

          sudo pkill -9 -f suricata 2>/dev/null || true
          sudo rm -f /var/run/suricata.pid 2>/dev/null || true
          sleep 1

          echo "–ó–∞–ø—É—Å–∫ Suricata —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –ø—Ä–∞–≤–∏–ª..."
          setsid nohup sudo -b sh -c '
            exec > /var/log/suricata/startup.log 2>&1
            exec suricata \
              -c /etc/suricata/suricata.yaml \
              -q 0 \
              --pidfile /var/run/suricata.pid \
              --set logging.console.enabled=no \
              --set detect.profiling-rules.enabled=yes
          ' </dev/null >/dev/null 2>&1 &

          # –ñ–¥—ë–º PID –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
          for i in {1..20}; do
            if [ -f /var/run/suricata.pid ]; then
              PID=$(cat /var/run/suricata.pid)
              echo "PID: $PID"
              break
            fi
            sleep 0.5
          done

          if [ ! -f /var/run/suricata.pid ]; then
            echo "‚ùå PID –Ω–µ —Å–æ–∑–¥–∞–Ω"
            cat /var/log/suricata/startup.log 2>/dev/null || echo "(–ª–æ–≥ –ø—É—Å—Ç)"
            exit 1
          fi

          # –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª (–ø–æ—è–≤–ª–µ–Ω–∏—è alert/drop –≤ –ª–æ–≥–µ)
          timeout 20 bash -c '
            while ! sudo grep -q "rules successfully loaded" /var/log/suricata/suricata.log &&
                  ! sudo grep -q "\"rules_loaded\":[1-9]" /var/log/suricata/eve.json 2>/dev/null; do
              kill -0 "$PID" || exit 1
              sleep 0.5
            done
          ' || {
            echo "‚ùå –ü—Ä–∞–≤–∏–ª–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
            sudo tail -n 50 /var/log/suricata/suricata.log
            exit 1
          }

          echo "‚úÖ Suricata –∑–∞–ø—É—â–µ–Ω–∞ –∏ –∑–∞–≥—Ä—É–∑–∏–ª–∞ –ø—Ä–∞–≤–∏–ª–∞"
          exit 0
          EOF

      - name: Deploy containers
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            cd ~/lab-infrastructure

            docker network create labnet 2>/dev/null || true

            docker compose up -d --build

            echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã:"
            docker compose ps
          EOF

      - name: Configure iptables for Suricata IPS
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iptables –¥–ª—è Suricata IPS ==="

          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è bridge-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          BRIDGE_NAME="br-$(docker network inspect labnet -f '{{.Id}}' | cut -c1-12)"
          echo "Bridge: $BRIDGE_NAME"

          if ! ip link show "$BRIDGE_NAME" >/dev/null 2>&1; then
            echo "‚ùå Bridge $BRIDGE_NAME –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–ø–∏—Å–æ–∫:"
            ip -br link show type bridge
            exit 1
          fi

          # --- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏: —É–¥–∞–ª—è–µ–º –í–°–Å, —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å PRE-SURICATA ---
          echo "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–∞–≤–∏–ª..."

          # –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –∏–∑ DOCKER-USER (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî —É–¥–∞–ª—è–µ–º –≤ —Ü–∏–∫–ª–µ)
          while sudo iptables -C DOCKER-USER -j PRE-SURICATA 2>/dev/null; do
            sudo iptables -D DOCKER-USER -j PRE-SURICATA
          done

          # –û—á–∏—â–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ü–µ–ø–æ—á–∫—É, –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          sudo iptables -F PRE-SURICATA 2>/dev/null || true
          sudo iptables -X PRE-SURICATA 2>/dev/null || true

          # –°–æ–∑–¥–∞—ë–º –∑–∞–Ω–æ–≤–æ
          echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ PRE-SURICATA..."
          sudo iptables -N PRE-SURICATA
          sudo iptables -A DOCKER-USER -j PRE-SURICATA

          # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è bridge
          sudo iptables -A PRE-SURICATA -i "$BRIDGE_NAME" -j NFQUEUE --queue-num 0 --queue-bypass
          sudo iptables -A PRE-SURICATA -o "$BRIDGE_NAME" -j NFQUEUE --queue-num 0 --queue-bypass

          echo "‚úÖ iptables –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
          sudo iptables -L DOCKER-USER -n -v
          exit 0
          EOF

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            cd ~/lab-infrastructure

            echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            docker compose ps

            echo ""
            echo "=== –°—Ç–∞—Ç—É—Å Suricata (PID/–ø—Ä–æ—Ü–µ—Å—Å) ==="
            if [ -f /var/run/suricata.pid ]; then
              PID=$(cat /var/run/suricata.pid)
              if kill -0 "$PID" 2>/dev/null; then
                echo "‚úÖ Suricata —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $PID)"
              else
                echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å Suricata –∑–∞–≤–µ—Ä—à—ë–Ω"
                exit 1
              fi
            else
              echo "‚ùå PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi

            echo ""
            echo "=== –ü—Ä–∞–≤–∏–ª–∞ iptables ==="
            sudo iptables -L DOCKER-USER -n -v

            echo ""
            echo "=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–±—ã—Ç–∏–π Suricata ==="
            sudo tail -n 20 /var/log/suricata/eve.json 2>/dev/null | jq -r .event_type // . 2>/dev/null || echo "(–ª–æ–≥–∏ –ø—É—Å—Ç—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)"
          EOF

      - name: Test Suricata IPS protection
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            cd ~/lab-infrastructure

            echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ICMP –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è, HTTP ‚Äî –ø—Ä–æ—Ö–æ–¥–∏—Ç—å ==="
            sleep 5

            echo "‚Üí –¢–µ—Å—Ç ICMP (–æ–∂–∏–¥–∞–µ—Ç—Å—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞):"
            if docker exec attacker timeout 3 ping -c 1 -W 1 victim &>/dev/null; then
              echo "‚ùå ICMP –ø—Ä–æ—à—ë–ª ‚Äî Suricata –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç!"
              sudo tail -n 20 /var/log/suricata/eve.json | grep -i icmp || true
              exit 1
            else
              echo "‚úÖ ICMP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
            fi

            echo "‚Üí –¢–µ—Å—Ç HTTP (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ):"
            if docker exec attacker timeout 5 curl -s --connect-timeout 3 http://victim &>/dev/null; then
              echo "‚úÖ HTTP –ø—Ä–æ—à—ë–ª"
              echo "‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ –≤ Suricata (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –µ—Å—Ç—å):"
              if sudo grep -q '"icmp"' /var/log/suricata/eve.json 2>/dev/null; then
                echo "‚ö†Ô∏è ICMP-—Å–æ–±—ã—Ç–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ (–æ–∂–∏–¥–∞–µ–º–æ)"
              fi
            else
              echo "‚ùå HTTP –Ω–µ –ø—Ä–æ—à—ë–ª ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, Suricata —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è –∏–ª–∏ victim –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
              docker exec victim ps aux | head -5 || echo "Victim: —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω?"
              exit 1
            fi

            echo "=== üéâ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ! ==="
          EOF