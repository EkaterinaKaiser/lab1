name: Deploy Lab Infrastructure (Suricata on Host)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Cleanup previous deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            echo "=== –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–µ–ø–ª–æ—è ==="

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Suricata –Ω–∞ —Ö–æ—Å—Ç–µ
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ Suricata..."
            sudo pkill -f "suricata.*-c /etc/suricata/suricata.yaml" 2>/dev/null || true
            sleep 3
            sudo rm -f /var/run/suricata.pid 2>/dev/null || true

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            cd ~ || mkdir -p ~/lab-infrastructure && cd ~/lab-infrastructure
            if [ -f docker-compose.yml ]; then
              docker compose down -v 2>/dev/null || true
            fi

            # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ –∏–º–µ–Ω–∏ (–Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è compose)
            docker rm -f attacker victim 2>/dev/null || true

            # –£–¥–∞–ª—è–µ–º —Å–µ—Ç—å (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
            docker network rm labnet 2>/dev/null || true

            # –û—á–∏—â–∞–µ–º –ø–∞–ø–∫—É
            rm -rf ~/lab-infrastructure
            mkdir -p ~/lab-infrastructure/{rules,logs}

            echo "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          EOF

      - name: Copy files to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" "mkdir -p ~/lab-infrastructure/rules"

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            suricata.yaml \
            ${SSH_USER}@${SSH_HOST}:~/lab-infrastructure/

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -r rules/ \
            ${SSH_USER}@${SSH_HOST}:~/lab-infrastructure/

      - name: Install and configure Suricata on host
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Suricata –Ω–∞ —Ö–æ—Å—Ç ==="

            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–∫–µ—Ç—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Suricata
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository -y ppa:oisf/suricata-stable
            sudo apt-get update
            sudo apt-get install -y suricata

            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥–∏
            sudo mkdir -p /etc/suricata/rules
            sudo cp ~/lab-infrastructure/suricata.yaml /etc/suricata/suricata.yaml
            sudo cp ~/lab-infrastructure/rules/* /etc/suricata/rules/ 2>/dev/null || true

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º suricata.yaml..."
            sudo suricata -T -c /etc/suricata/suricata.yaml || { echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!"; exit 1; }

            echo "Suricata —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
          EOF

      - name: Start Suricata in IPS mode (nfq)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "=== –ó–∞–ø—É—Å–∫ Suricata –≤ —Ä–µ–∂–∏–º–µ IPS (nfq) ==="

          sudo modprobe nfnetlink_queue 2>/dev/null || true
          sudo pkill -f "suricata.*-c /etc/suricata/suricata.yaml" 2>/dev/null || true
          sleep 1
          sudo rm -f /var/run/suricata.pid 2>/dev/null || true

          echo "–ó–∞–ø—É—Å–∫ Suricata –≤ —Ñ–æ–Ω–µ (–ø–æ–ª–Ω–æ–µ –æ—Ç—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)..."
          nohup sudo suricata \
            -c /etc/suricata/suricata.yaml \
            -q 0 \
            --pidfile /var/run/suricata.pid \
            --set logging.console.enabled=no \
            > /var/log/suricata/startup.log 2>&1 < /dev/null &
          
          # –ñ–¥—ë–º PID-—Ñ–∞–π–ª–∞
          for i in {1..15}; do
            if [ -f /var/run/suricata.pid ]; then
              PID=$(cat /var/run/suricata.pid)
              echo "Suricata –∑–∞–ø—É—â–µ–Ω–∞ (PID: $PID)"
              break
            fi
            sleep 1
          done

          if [ ! -f /var/run/suricata.pid ]; then
            echo "‚ùå PID-—Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞–Ω. –õ–æ–≥ –∑–∞–ø—É—Å–∫–∞:"
            cat /var/log/suricata/startup.log 2>/dev/null || echo "(–ª–æ–≥ –ø—É—Å—Ç)"
            exit 1
          fi

          # –ñ–¥—ë–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ, —Ç.–∫. Suricata –≤ —Ñ–æ–Ω–µ)
          timeout 20 bash -c '
            while ! sudo grep -q "Engine started" /var/log/suricata/suricata.log 2>/dev/null; do
              if ! kill -0 "$(cat /var/run/suricata.pid)" 2>/dev/null; then
                echo "Suricata —É–ø–∞–ª–∞"
                exit 1
              fi
              sleep 0.5
            done
          ' || {
            echo "‚ùå –¢–∞–π–º–∞—É—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"
            sudo tail -n 30 /var/log/suricata/suricata.log 2>/dev/null
            exit 1
          }

          echo "‚úÖ Suricata —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $(cat /var/run/suricata.pid))"
          exit 0
          EOF

      - name: Deploy containers
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            cd ~/lab-infrastructure

            docker network create labnet 2>/dev/null || true

            docker compose up -d --build

            echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã:"
            docker compose ps
          EOF

      - name: Configure iptables to inspect inter-container traffic
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iptables –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ attacker ‚Üí victim ==="

            # –û—á–∏—â–∞–µ–º DOCKER-USER
            sudo iptables -F DOCKER-USER
            sudo iptables -X PRE-SURICATA 2>/dev/null || true
            sudo iptables -N PRE-SURICATA

            # –ü—Ä–∞–≤–∏–ª–æ: –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –æ—Ç attacker –∫ victim –≤ NFQUEUE
            # –ü–æ–ª—É—á–∞–µ–º IP-–∞–¥—Ä–µ—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ (–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Äî —Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫–∏)
            # –ù–æ –ª—É—á—à–µ ‚Äî –ø–æ MAC –∏–ª–∏ –∏–º–µ–Ω–∏, –Ω–æ –¥–ª—è –ª–∞–±—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

            # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ø–µ—Ä–µ—Ö–≤–∞—Ç –í–°–ï–ì–û —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ labnet (–Ω–∞–¥—ë–∂–Ω–µ–µ)
            echo "–î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –≤—Å–µ–π —Å–µ—Ç–∏ labnet..."

            # –°–æ–∑–¥–∞—ë–º —Ü–µ–ø–æ—á–∫—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É (docker —Å–æ–∑–¥–∞—ë—Ç veth-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)
            sudo iptables -A DOCKER-USER -j PRE-SURICATA

            # –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞—Ñ–∏–∫, –ø—Ä–æ—Ö–æ–¥—è—â–∏–π —á–µ—Ä–µ–∑ bridge (–≤—Ö–æ–¥—è—â–∏–π/–∏—Å—Ö–æ–¥—è—â–∏–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
            # –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ —Å–µ—Ç—å labnet ‚Äî bridge (–∞ –æ–Ω–∞ —Ç–∞–∫–∞—è)
            sudo iptables -A PRE-SURICATA -i br-$(docker network inspect labnet -f '{{.Id}}' | cut -c1-12) -j NFQUEUE --queue-num 0 --queue-bypass
            sudo iptables -A PRE-SURICATA -o br-$(docker network inspect labnet -f '{{.Id}}' | cut -c1-12) -j NFQUEUE --queue-num 0 --queue-bypass

            echo "‚úÖ –ü—Ä–∞–≤–∏–ª–∞ iptables –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
            sudo iptables -L DOCKER-USER -n -v
          EOF

      - name: Configure iptables for Suricata IPS
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -e
          echo "=== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iptables –¥–ª—è Suricata IPS ==="

          # –ü–æ–ª—É—á–∞–µ–º ID —Å–µ—Ç–∏ –∏ –∏–º—è bridge-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
          NETWORK_ID=$(docker network inspect labnet -f '{{.Id}}')
          BRIDGE_NAME="br-$(echo "$NETWORK_ID" | cut -c1-12)"
          echo "Network ID: $NETWORK_ID"
          echo "Bridge interface: $BRIDGE_NAME"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          if ! ip link show "$BRIDGE_NAME" &>/dev/null; then
            echo "‚ùå Bridge $BRIDGE_NAME –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–ø–∏—Å–æ–∫ bridge-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:"
            ip -br link show type bridge
            exit 1
          fi

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ iptables
          sudo iptables -F DOCKER-USER 2>/dev/null || true
          sudo iptables -X PRE-SURICATA 2>/dev/null || true
          sudo iptables -N PRE-SURICATA
          sudo iptables -A DOCKER-USER -j PRE-SURICATA
          sudo iptables -A PRE-SURICATA -i "$BRIDGE_NAME" -j NFQUEUE --queue-num 0 --queue-bypass
          sudo iptables -A PRE-SURICATA -o "$BRIDGE_NAME" -j NFQUEUE --queue-num 0 --queue-bypass

          echo "‚úÖ iptables –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è $BRIDGE_NAME"
          sudo iptables -L DOCKER-USER -n -v
          exit 0
          EOF

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            cd ~/lab-infrastructure

            echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            docker compose ps

            echo ""
            echo "=== –°—Ç–∞—Ç—É—Å Suricata (PID/–ø—Ä–æ—Ü–µ—Å—Å) ==="
            if [ -f /var/run/suricata.pid ]; then
              PID=$(cat /var/run/suricata.pid)
              if kill -0 "$PID" 2>/dev/null; then
                echo "‚úÖ Suricata —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $PID)"
              else
                echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å Suricata –∑–∞–≤–µ—Ä—à—ë–Ω"
                exit 1
              fi
            else
              echo "‚ùå PID-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi

            echo ""
            echo "=== –ü—Ä–∞–≤–∏–ª–∞ iptables ==="
            sudo iptables -L DOCKER-USER -n -v

            echo ""
            echo "=== –ü–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–±—ã—Ç–∏–π Suricata ==="
            sudo tail -n 20 /var/log/suricata/eve.json 2>/dev/null | jq -r .event_type // . 2>/dev/null || echo "(–ª–æ–≥–∏ –ø—É—Å—Ç—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç)"
          EOF

      - name: Test Suricata IPS protection
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "${SSH_USER}@${SSH_HOST}" << 'EOF'
            set -e
            cd ~/lab-infrastructure

            echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ICMP –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è, HTTP ‚Äî –ø—Ä–æ—Ö–æ–¥–∏—Ç—å ==="
            sleep 5

            echo "‚Üí –¢–µ—Å—Ç ICMP (–æ–∂–∏–¥–∞–µ—Ç—Å—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞):"
            if docker exec attacker timeout 3 ping -c 1 -W 1 victim &>/dev/null; then
              echo "‚ùå ICMP –ø—Ä–æ—à—ë–ª ‚Äî Suricata –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç!"
              sudo tail -n 20 /var/log/suricata/eve.json | grep -i icmp || true
              exit 1
            else
              echo "‚úÖ ICMP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
            fi

            echo "‚Üí –¢–µ—Å—Ç HTTP (–æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ):"
            if docker exec attacker timeout 5 curl -s --connect-timeout 3 http://victim &>/dev/null; then
              echo "‚úÖ HTTP –ø—Ä–æ—à—ë–ª"
              echo "‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ –≤ Suricata (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –µ—Å—Ç—å):"
              if sudo grep -q '"icmp"' /var/log/suricata/eve.json 2>/dev/null; then
                echo "‚ö†Ô∏è ICMP-—Å–æ–±—ã—Ç–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ (–æ–∂–∏–¥–∞–µ–º–æ)"
              fi
            else
              echo "‚ùå HTTP –Ω–µ –ø—Ä–æ—à—ë–ª ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, Suricata —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∞—è –∏–ª–∏ victim –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
              docker exec victim ps aux | head -5 || echo "Victim: —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω?"
              exit 1
            fi

            echo "=== üéâ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ! ==="
          EOF