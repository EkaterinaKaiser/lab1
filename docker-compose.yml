services:
  victim:
    image: alpine:latest
    container_name: victim
    hostname: victim
    networks:
      - labnet
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        apk add --no-cache python3 curl iputils busybox-extras netcat-openbsd wget &&
        echo '<h1>Welcome to victim HTTP server!</h1>' > /tmp/index.html &&
        python3 -m http.server 80 --bind 0.0.0.0 &
        while true; do sleep 3600; done
      "
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 10s
      timeout: 5s
      retries: 3

  attacker:
    image: kalilinux/kali-rolling:latest
    container_name: attacker
    hostname: attacker
    networks:
      - labnet
    cap_add:
      - NET_ADMIN
    command: >
      sh -c "
        apt-get update -qq &&
        apt-get install -y -qq iputils-ping curl netcat-openbsd nmap wget tcpdump &&
        tail -f /dev/null
      "

  suricata:
    image: jasonish/suricata:latest
    container_name: suricata
    hostname: suricata
    privileged: true
    # Используем network_mode: host для доступа к NFQUEUE и bridge интерфейсам
    network_mode: host
    volumes:
      - ./suricata.yaml:/etc/suricata/suricata.yaml:ro
      - ./rules:/etc/suricata/rules:ro
      - ./logs:/var/log/suricata
      - ./start-suricata-ips.sh:/start-suricata-ips.sh:ro
    depends_on:
      - victim
      - attacker
    entrypoint: []
    # Запуск Suricata в режиме IPS с NFQUEUE
    command: ["/bin/sh", "/start-suricata-ips.sh"]
      
networks:
  labnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
